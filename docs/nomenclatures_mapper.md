# Сервис маппинга номенклатуры

## Описание

Веб-сервис для сопоставления номенклатур поставщиков с номенклатурами из базы.

## Как запустить маппинг

1. Отправляем запрос `POST /mapping`

   **Пример тела запроса:**

    ```json
    {
      "nomenclatures": [
        {
          "row_number": 0,
          "nomenclature": "<наименование номенклатуры>"
        }
      ],
      "most_similar_count": 3,
      "chunk_size": 100,
      "is_use_brand_recognition": true
    }
    ```

    - `row_number` - индекс номенклатуры в списке
    - `most_similar_count` - количество похожих номенклатур, если вдруг не нашлось нужной номенклатуры (Default: 3)
    - `chunk_size` - количество обрабатываемых номенклатур в одном чанке (Default: 100)
    - `is_use_brand_recognition` - когда `true`, номенклатуры будут сопоставляться ещё и по брендам (Default: true)

   Параметры `most_similar_count`, `chunk_size`, `is_use_brand_recognition` имеют дефолтное рекомендованное значение для
   получения наилучшего результата. При необходимости изменения этих параметров, лучше сначала посоветоваться с нами.

2. Получаем в ответе `job_id` - ID задачи, в которой запущено сопоставление

3. Далее ждём пока все номенклатуры сопоставятся. Проверить статус сопоставления можно, отправив
   запрос `GET /mapping/{job_id}`

   В ответе мы получаем список всех задач, где сопоставляется какое-то количество номенклатур.
   Внутри есть список `nomenclatures`, где находится информация по каждой номенклатуре.

   ```json
   [
     {
       "job_id": "<ID задачи>",
       "ready_count": 0,
       "total_count": 0,
       "general_status": "<статус задачи>", // подробнее ниже в пункте "Статусы задач"
       "nomenclatures": [
         {
           "row_number": 0,
           "nomenclature": "<исходная номенклатура>",
           "group": "<найденная группа>",
           "nomenclature_params": [
            {
             "<название параметра>": "<значение параметра>"
            }
           ],
           "mappings": [
             {
               "nomenclature_guid": "<ID номенклатуры>",
               "nomenclature": "<смапленная номенклатура>",
               "similarity_score": 0.0
             }
           ],
           "similar_mappings": [
             {
               "nomenclature_guid": "<ID номенклатуры>",
               "nomenclature": "<смапленная номенклатура>",
               "similarity_score": 0.0
             }
           ]
         }
       ]
     }
   ]
   ```

   Параметры связанные с задачей:
    - `ready_count` - кол-во уже сопоставленных номенклатур
    - `total_count` - общее кол-во номенклатур, которое нужно сопоставить
    - `general_status` - статус задачи. Подробнее про них в пункте ["Статусы задач"](#статусы-задач).
      **Это основной параметр результата работы маппера**

   Параметры связанные с номенклатурами:
    - `nomenclature` - исходная номенклатура, которую мы сопоставляли
    - `group` - найденная группа, к которой в теории наша номенклатура относится.
      **Это основной параметр результата работы маппера**
    - `nomenclature_params` - список параметров, которые мы смогли определить из названия номенклатуры
    - `mappings` - список с подходящими номенклатурами (обычно состоит из 1 номенклатуры).
      **Это основной параметр результата работы маппера**
    - `similar_mappings` - список похожих номенклатур, например с похожим названием,
      такими же параметрами или таким же брендом.
      **Это основной параметр результата работы маппера**

   Параметры внутри `mappings` и `similar_mappings`:
    - `nomenclature_guid` - ID номенклатуры в базе
    - `nomenclature` - смапленная номенклатура.
      **Это основной параметр результата работы маппера**
    - `similarity_score` - векторное расстояние между исходной и смапленной номенклатурами.
      Чем ближе число к 0, тем ближе вектора, а значит тем больше похожи номенклатуры

---

### Синхронизация номенклатуры - `в процессе`

...

---

### Статусы задач

Когда задача создаётся в очереди - ей прописывается статус.

Вот основные из них:

- `queued` - добавлена в очередь, но ещё не выполняется
- `started` - задача сейчас выполняется
- `finished` - задача выполнена
- `failed` - в задаче возникла ошибка

> Задачи висят на фоне. Посмотреть результат их выполнения можно с помощью API ручек, у которых на конце `/result`
