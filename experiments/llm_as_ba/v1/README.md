# LLM as BA

## Общая аналитика запросов от жителей и Создание базы знаний

### Цель

Разработка системы для автоматизированного анализа обращений жителей, выявления типовых проблем и формирования базы знаний для улучшения клиентского сервиса.

### Модули и их зоны ответственности

#### 1. Модуль анализа

-   Принимает выгрузку заявок с определенной схемой данных
-   Проходится по каждой заявке и пытается собрать общую картину проблем
-   Определяет интент (намерение жителя) из текста обращения, чата и комментария исполнителя
-   Определяет источник интента (содержание заявки, чат или оба источника)
-   Определяет сценарий обработки:
    -   **Actionless - Q&A**: достаточно просто ответить на вопрос
    -   **Action-Required**: требуются действия для решения проблемы (вызов инженера, изменение данных в CRM и т.д.)

#### 2. База знаний типовых проблем

-   Собирает и агрегирует информацию о типовых проблемах
-   Для каждой проблемы хранит:
    -   Интент жителя (почему обратился)
    -   Классификацию проблемы
    -   Количество обращений по этой проблеме
    -   Тип сценария (Actionless - Q&A или Action-Required)
    -   Метаинформацию по сценарию (ответ или необходимое действие)

### Использование

Для запуска анализа необходимо отредактировать константы в начале файла `main.py`:

```python
# Константы для настройки
INPUT_FILE_PATH = "/path/to/your/input/file.xlsx"  # Путь к входному Excel файлу
OUTPUT_DIR_PATH = "/path/to/your/output/directory"  # Путь к директории для результатов
SHEET_NAME = "Sheet1"  # Имя листа в Excel файле
REQUEST_ID_FIELD = "id"  # Имя поля с ID заявки
REQUEST_CONTENT_FIELD = "content"  # Имя поля с содержанием заявки
SERVICE_FIELD = "service"  # Имя поля с услугой
EXECUTOR_COMMENT_FIELD = "executor_comment"  # Имя поля с комментарием исполнителя
CHAT_HISTORY_FIELD = "chat"  # Имя поля с историей чата
VERBOSE = False  # Включить подробный вывод
```

Затем запустить:

```bash
python -m llm_as_ba.v1.main
```

Или использовать пример:

```bash
python -m llm_as_ba.v1.run_example
```

Для анализа одного запроса:

```bash
python -m llm_as_ba.v1.analyze_single_request --content "Не работает отопление в квартире" --service "ЖКХ" --executor-comment "Отправлен специалист" --chat "Житель: Когда починят? Оператор: Скоро"
```

### Формат входных данных

#### Excel файл

Система принимает на вход Excel файл со следующими полями:

-   `id` - ID заявки
-   `content` - Содержание заявки
-   `service` - Услуга (опционально)
-   `executor_comment` - Комментарий исполнителя (опционально)
-   `chat` - История чата (опционально)

### Результаты

Система создает следующие файлы в указанной директории:

1. `Enriched Requests [дата-время].xlsx` - Excel-файл с исходными данными и результатами анализа для каждой заявки
2. `Knowledge Base Summary [дата-время].xlsx` - Excel-файл с сводкой по базе знаний
3. `analyses.json` - результаты анализа всех заявок (базовая информация)
4. `unified_analyses.json` - расширенные результаты анализа с дополнительными полями
5. `knowledge_base.json` - полная база знаний типовых проблем
6. `knowledge_base_summary.json` - сводка по наиболее частым проблемам

#### Структура обогащенного Excel-файла

Файл `Enriched Requests [дата-время].xlsx` содержит все исходные данные из входного файла, а также следующие дополнительные поля для каждой заявки:

-   `intent_text` - Текст интента (намерение жителя)
-   `intent_confidence` - Уверенность в определении интента (от 0 до 1)
-   `intent_source` - Источник интента (содержание заявки, чат или оба)
-   `scenario_type` - Тип сценария (actionless_qa или action_required)
-   `scenario_description` - Описание сценария
-   `scenario_response_or_action` - Ответ на вопрос или необходимое действие
-   `intent_category` - Категория интента для базы знаний
-   `problem_classification` - Классификация проблемы для базы знаний

### Требования

-   Python 3.8+
-   Зависимости указаны в requirements.txt
-   Доступ к API OpenAI или Azure OpenAI

### Переменные окружения

-   `OPENAI_API_KEY` - API ключ OpenAI
-   `AZURE_OPENAI_API_KEY` - API ключ Azure OpenAI
-   `AZURE_OPENAI_API_BASE` - Базовый URL для Azure OpenAI
-   `AZURE_OPENAI_API_VERSION` - Версия API Azure OpenAI
-   `AZURE_OPENAI_DEPLOYMENT_NAME` - Имя развертывания модели в Azure OpenAI
